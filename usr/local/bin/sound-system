#!/bin/bash
# WehttamSnaps Adaptive Sound System
# Automatically switches between J.A.R.V.I.S. and iDroid based on context
# Author: Matthew (WehttamSnaps)

set -euo pipefail

# ================================
# CONFIGURATION
# ================================

SOUND_BASE="/usr/share/wehttamsnaps/sounds"
STATE_FILE="$HOME/.cache/wehttamsnaps/sound-mode.state"
WORKSPACE_FILE="$HOME/.cache/wehttamsnaps/current-workspace.state"

# Ensure directories exist
mkdir -p "$(dirname "$STATE_FILE")"
mkdir -p "$SOUND_BASE"/{jarvis,idroid}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# ================================
# SOUND MODE MANAGEMENT
# ================================

get_current_mode() {
    if [[ -f "$STATE_FILE" ]]; then
        cat "$STATE_FILE"
    else
        echo "jarvis"
    fi
}

set_mode() {
    local mode="$1"
    echo "$mode" > "$STATE_FILE"
    echo -e "${CYAN}ğŸ”Š Sound mode:${NC} ${GREEN}$mode${NC}"
}

get_current_workspace() {
    # Try to get workspace from Niri
    if command -v niri &> /dev/null; then
        niri msg workspaces | grep -oP 'Workspace \K\d+' | head -1 || echo "1"
    elif [[ -f "$WORKSPACE_FILE" ]]; then
        cat "$WORKSPACE_FILE"
    else
        echo "1"
    fi
}

# ================================
# AUTO-DETECT MODE BASED ON CONTEXT
# ================================

auto_detect_mode() {
    local workspace
    workspace=$(get_current_workspace)

    # Gaming workspaces (2, 6, 7) -> iDroid
    if [[ "$workspace" =~ ^(2|6|7)$ ]]; then
        echo "idroid"
        return
    fi

    # Photography workspace (3) -> J.A.R.V.I.S.
    if [[ "$workspace" == "3" ]]; then
        echo "jarvis"
        return
    fi

    # Check if gaming mode is active
    if [[ -f "$HOME/.cache/wehttamsnaps/gaming-mode.active" ]]; then
        echo "idroid"
        return
    fi

    # Default to J.A.R.V.I.S.
    echo "jarvis"
}

# ================================
# PLAY SOUND FUNCTION
# ================================

play_sound() {
    local sound_name="$1"
    local force_mode="${2:-}"

    # Determine which mode to use
    local mode
    if [[ -n "$force_mode" ]]; then
        mode="$force_mode"
    else
        mode=$(auto_detect_mode)
    fi

    local sound_path="$SOUND_BASE/$mode/$sound_name.mp3"

    # Fallback to other mode if sound doesn't exist
    if [[ ! -f "$sound_path" ]]; then
        local alt_mode
        [[ "$mode" == "jarvis" ]] && alt_mode="idroid" || alt_mode="jarvis"
        sound_path="$SOUND_BASE/$alt_mode/$sound_name.mp3"
    fi

    # Play sound if exists
    if [[ -f "$sound_path" ]]; then
        paplay "$sound_path" &
    else
        echo -e "${YELLOW}âš ${NC} Sound not found: $sound_name.mp3"
    fi
}

# ================================
# SPECIFIC SOUND ACTIONS
# ================================

audio_mute_toggle() {
    wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle

    if wpctl get-volume @DEFAULT_AUDIO_SINK@ | grep -q "MUTED"; then
        play_sound "audio-mute"
    else
        play_sound "audio-unmute"
    fi
}

audio_volume_up() {
    wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+
    play_sound "volume-up"
}

audio_volume_down() {
    wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
    play_sound "volume-down"
}

mic_mute_toggle() {
    wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle

    if wpctl get-volume @DEFAULT_AUDIO_SOURCE@ | grep -q "MUTED"; then
        play_sound "mic-mute"
    else
        play_sound "mic-unmute"
    fi
}

gaming_mode_toggle() {
    local gaming_flag="$HOME/.cache/wehttamsnaps/gaming-mode.active"

    if [[ -f "$gaming_flag" ]]; then
        # Disable gaming mode
        rm "$gaming_flag"
        set_mode "jarvis"
        play_sound "gamemode-off" "jarvis"
        notify-send "Gaming Mode" "Disabled - J.A.R.V.I.S. active" -i input-gaming
    else
        # Enable gaming mode
        touch "$gaming_flag"
        set_mode "idroid"
        play_sound "gamemode-on" "idroid"
        notify-send "Gaming Mode" "Enabled - iDroid active" -i input-gaming
    fi
}

workspace_switch() {
    local workspace="$1"
    echo "$workspace" > "$WORKSPACE_FILE"

    # Auto-detect and switch mode
    local new_mode
    new_mode=$(auto_detect_mode)
    set_mode "$new_mode"

    play_sound "workspace-switch"
}

# ================================
# SYSTEM EVENTS
# ================================

system_startup() {
    set_mode "jarvis"
    play_sound "startup" "jarvis"
}

system_shutdown() {
    play_sound "shutdown" "jarvis"
}

notification() {
    play_sound "notification"
}

screenshot_taken() {
    play_sound "screenshot"
}

window_close() {
    play_sound "window-close"
}

steam_launch() {
    set_mode "idroid"
    play_sound "steam-launch" "idroid"
}

photo_export() {
    play_sound "photo-export" "jarvis"
}

# ================================
# TESTING & PREVIEW
# ================================

test_all_sounds() {
    echo -e "${CYAN}ğŸ”Š Testing all sounds...${NC}\n"

    for mode in jarvis idroid; do
        echo -e "${BLUE}â”â”â” $mode sounds â”â”â”${NC}"

        if [[ -d "$SOUND_BASE/$mode" ]]; then
            for sound in "$SOUND_BASE/$mode"/*.mp3; do
                if [[ -f "$sound" ]]; then
                    local name
                    name=$(basename "$sound" .mp3)
                    echo -e "  ${GREEN}â–¶${NC} Playing: $name"
                    paplay "$sound"
                    sleep 0.5
                fi
            done
        else
            echo -e "  ${YELLOW}âš ${NC} Directory not found: $SOUND_BASE/$mode"
        fi
        echo ""
    done
}

preview_sound() {
    local sound_name="$1"
    local mode="${2:-jarvis}"

    local sound_path="$SOUND_BASE/$mode/$sound_name.mp3"

    if [[ -f "$sound_path" ]]; then
        echo -e "${GREEN}â–¶${NC} Playing: $mode/$sound_name.mp3"
        paplay "$sound_path"
    else
        echo -e "${RED}âœ—${NC} Sound not found: $sound_path"
        exit 1
    fi
}

list_sounds() {
    echo -e "${CYAN}ğŸ“ Available sounds:${NC}\n"

    for mode in jarvis idroid; do
        echo -e "${BLUE}â”â”â” $mode â”â”â”${NC}"

        if [[ -d "$SOUND_BASE/$mode" ]]; then
            local count=0
            for sound in "$SOUND_BASE/$mode"/*.mp3; do
                if [[ -f "$sound" ]]; then
                    local name
                    name=$(basename "$sound" .mp3)
                    echo -e "  ${GREEN}â€¢${NC} $name"
                    ((count++))
                fi
            done

            if [[ $count -eq 0 ]]; then
                echo -e "  ${YELLOW}âš ${NC} No sounds found"
            fi
        else
            echo -e "  ${RED}âœ—${NC} Directory not found"
        fi
        echo ""
    done
}

# ================================
# SOUND LIBRARY SETUP
# ================================

setup_sound_library() {
    echo -e "${CYAN}ğŸ”§ Setting up sound library...${NC}\n"

    # Create directory structure
    mkdir -p "$SOUND_BASE"/{jarvis,idroid}

    # Create README files
    cat > "$SOUND_BASE/jarvis/README.md" << 'EOF'
# J.A.R.V.I.S. (Paul Bettany) Sounds

Download from: https://www.101soundboards.com/boards/10155-jarvis-v1-paul-bettany

## Required Sounds:
- startup.mp3
- shutdown.mp3
- notification.mp3
- audio-mute.mp3
- audio-unmute.mp3
- volume-up.mp3
- volume-down.mp3
- mic-mute.mp3
- mic-unmute.mp3
- workspace-switch.mp3
- screenshot.mp3
- window-close.mp3
- photo-export.mp3
- gamemode-off.mp3

## Suggested Phrases:
- startup: "Allow me to introduce myself, I am JARVIS"
- shutdown: "Shutting down. Have a good day, Matthew"
- notification: "Sir, you have a notification"
- audio-mute: "Audio muted, sir"
- audio-unmute: "Audio restored"
- volume-up: "Volume increased"
- volume-down: "Volume decreased"
- workspace-switch: "Workspace changed"
- screenshot: "Screenshot captured"
- photo-export: "Export complete, sir"
EOF

    cat > "$SOUND_BASE/idroid/README.md" << 'EOF'
# iDroid Voice Sounds

Download from: https://www.101soundboards.com/boards/10060-idroid-voice

## Required Sounds:
- gamemode-on.mp3
- gamemode-off.mp3
- alert-high.mp3
- alert-medium.mp3
- steam-launch.mp3
- notification.mp3
- workspace-switch.mp3

## Suggested Phrases:
- gamemode-on: "Combat systems online"
- gamemode-off: "Returning to normal operations"
- alert-high: "Alert! High priority"
- steam-launch: "Game launching"
EOF

    echo -e "${GREEN}âœ“${NC} Created directory structure"
    echo -e "${GREEN}âœ“${NC} Created README files"
    echo ""
    echo -e "${YELLOW}ğŸ“¥ Next steps:${NC}"
    echo -e "  1. Visit https://www.101soundboards.com/"
    echo -e "  2. Download sounds for J.A.R.V.I.S. and iDroid"
    echo -e "  3. Place them in:"
    echo -e "     ${BLUE}$SOUND_BASE/jarvis/${NC}"
    echo -e "     ${BLUE}$SOUND_BASE/idroid/${NC}"
    echo -e "  4. Run: ${CYAN}sound-system list${NC} to verify"
}

# ================================
# MAIN COMMAND DISPATCHER
# ================================

show_help() {
    cat << EOF
${CYAN}WehttamSnaps Adaptive Sound System${NC}
Automatically switches between J.A.R.V.I.S. and iDroid

${YELLOW}Usage:${NC}
  sound-system <command> [args]

${YELLOW}Commands:${NC}
  ${GREEN}Audio Controls:${NC}
    mute              Toggle audio mute
    volume-up         Increase volume
    volume-down       Decrease volume
    mic-mute          Toggle microphone mute

  ${GREEN}System Events:${NC}
    startup           Play startup sound
    shutdown          Play shutdown sound
    notification      Play notification
    screenshot        Play screenshot sound
    window-close      Play window close sound

  ${GREEN}Mode Management:${NC}
    gaming-toggle     Toggle gaming mode (switches to iDroid)
    workspace <num>   Switch workspace (auto-detects mode)
    mode <jarvis|idroid>  Force mode change
    auto-mode         Auto-detect mode from context

  ${GREEN}Sound Library:${NC}
    setup             Setup sound library structure
    list              List all available sounds
    test              Test all sounds
    preview <name> [mode]  Preview specific sound

  ${GREEN}Utilities:${NC}
    status            Show current mode and context
    help              Show this help

${YELLOW}Examples:${NC}
  sound-system mute
  sound-system gaming-toggle
  sound-system workspace 2
  sound-system preview startup jarvis
  sound-system test

${YELLOW}Niri Integration:${NC}
  Add to ~/.config/niri/conf.d/10-keybinds.kdl:

  XF86AudioMute { spawn "sound-system" "mute"; }
  Mod+G { spawn "sound-system" "gaming-toggle"; }
  Print { spawn "sh" "-c" "grim ~/Pictures/screenshot.png && sound-system screenshot"; }

EOF
}

show_status() {
    local current_mode
    current_mode=$(get_current_mode)
    local auto_mode
    auto_mode=$(auto_detect_mode)
    local workspace
    workspace=$(get_current_workspace)
    local gaming_active="No"
    [[ -f "$HOME/.cache/wehttamsnaps/gaming-mode.active" ]] && gaming_active="Yes"

    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}  Sound System Status${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${YELLOW}Current Mode:${NC}     $current_mode"
    echo -e "${YELLOW}Auto-Detected:${NC}    $auto_mode"
    echo -e "${YELLOW}Workspace:${NC}        $workspace"
    echo -e "${YELLOW}Gaming Mode:${NC}      $gaming_active"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# ================================
# MAIN
# ================================

case "${1:-help}" in
    # Audio controls
    mute) audio_mute_toggle ;;
    volume-up) audio_volume_up ;;
    volume-down) audio_volume_down ;;
    mic-mute) mic_mute_toggle ;;

    # System events
    startup) system_startup ;;
    shutdown) system_shutdown ;;
    notification) notification ;;
    screenshot) screenshot_taken ;;
    window-close) window_close ;;
    steam-launch) steam_launch ;;
    photo-export) photo_export ;;

    # Mode management
    gaming-toggle) gaming_mode_toggle ;;
    workspace) workspace_switch "${2:-1}" ;;
    mode) set_mode "${2:-jarvis}" ;;
    auto-mode)
        mode=$(auto_detect_mode)
        set_mode "$mode"
        ;;

    # Sound library
    setup) setup_sound_library ;;
    list) list_sounds ;;
    test) test_all_sounds ;;
    preview) preview_sound "${2:-startup}" "${3:-jarvis}" ;;

    # Utilities
    status) show_status ;;
    help|--help|-h) show_help ;;

    *)
        echo -e "${RED}âœ—${NC} Unknown command: $1"
        echo "Run 'sound-system help' for usage"
        exit 1
        ;;
esac
